<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>51121BoBiBo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/CCapture.js/1.1.0/CCapture.all.min.js"></script>
    <style>
        body { 
            margin: 0;
            text-align: center; 
            font-family: Arial, sans-serif; 
            background: #f0f0f0; 
        }
        .container { 
            display: flex; 
            justify-content: center; 
            align-items: flex-start; 
            gap: 20px; 
            padding: 20px;
            flex-wrap: wrap;
        }
        #canvas-container {
            width: 400px;
            height: 400px;
            border: 2px solid black;
            background: #fff;
            border-radius: 4px;
            position: relative;
        }
        .controls { 
            display: flex; 
            flex-direction: column; 
            gap: 10px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            min-width: 300px;
        }
        .shape-controls {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        .image-upload { 
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        button.active {
            background: #2E7D32;
            box-shadow: inset 0 0 5px rgba(0,0,0,0.2);
        }
        .music-controls {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .music-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .music-button {
            padding: 6px 12px;
            background: #2196F3;
        }
        
        .music-button.active {
            background: #1976D2;
        }
        
        .speed-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        .speed-controls label {
            margin-right: 5px;
        }
        
        .speed-controls input[type="range"] {
            flex: 1;
        }
        
        .speed-button {
            padding: 4px 8px;
            font-size: 12px;
            background: #2196F3;
        }
        
        .fullscreen-button {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.5);
            border: none;
            border-radius: 4px;
            padding: 8px;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .fullscreen-button:hover {
            background: rgba(0, 0, 0, 0.7);
        }
        
        .fullscreen-button svg {
            width: 20px;
            height: 20px;
            fill: white;
        }
        
        #canvas-container.fullscreen {
            width: 100% !important;
            height: 100% !important;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 9999;
            border: none;
            border-radius: 0;
        }
        
        .download-button {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #4CAF50;
            margin: 10px auto;
        }
        
        .download-button svg {
            width: 16px;
            height: 16px;
            fill: white;
        }
        
        .dialog-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .dialog-box {
            background: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            max-width: 80%;
            max-height: 80vh;
            overflow: auto;
        }
        
        .preview-video {
            max-width: 100%;
            max-height: 60vh;
            margin: 10px 0;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .dialog-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }
        
        .watermark {
            position: absolute;
            bottom: 40px;
            right: 40px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            pointer-events: none;
            z-index: 1000;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        .loading-spinner {
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

      
        @media screen and (max-width: 726px) {
            .container {
                flex-direction: column;
                align-items: center;
            }
            
            #canvas-container {
                width: 90%;
                max-width: 400px;
                height: auto;
                aspect-ratio: 1;
                margin-bottom: 20px;
            }
            
            .controls {
                width: 90%;
                max-width: 400px;
            }
            
            .shape-controls, .music-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .image-upload {
                width: 100%;
            }
            
            .image-upload label {
                display: block;
                margin-bottom: 10px;
            }
            
            .speed-controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .speed-controls input[type="range"] {
                width: 100%;
                margin: 10px 0;
            }
            
            h2 {
                font-size: 1.5em;
                margin: 10px 0;
            }
        }
   
        .container, #canvas-container, .controls {
            transition: all 0.3s ease-in-out;
        }
        
        .disabled-button {
            background-color: #cccccc !important;
            cursor: not-allowed !important;
            opacity: 0.7;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            min-height: 100vh;
            background-color: #f0f0f0;
            padding-top: 60px; /* 為固定導航欄留出空間 */
        }

        .header {
            background-color: rgba(51, 51, 51, 0.95);
            padding: 0.5rem;
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 1000;
            text-align: center;
            height: 50px; /* 固定高度 */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .header h1 {
            color: white;
            font-size: 1.2rem;
            margin: 0;
        }

        .hamburger {
            width: 30px; /* 縮小漢堡按鈕 */
            height: 30px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            cursor: pointer;
            position: fixed;
            top: 10px; /* 調整位置 */
            left: 10px;
            z-index: 9999;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 8px; /* 縮小內邊距 */
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .hamburger span {
            width: 100%;
            height: 2px; /* 縮小線條高度 */
            background-color: #ffffff;
            border-radius: 2px;
        }

        .menu-overlay {
            position: fixed;
            top: 50px; /* 從導航欄下方開始 */
            left: 0;
            width: 0;
            height: 0;
            background-color: rgba(30, 30, 30, 0.95);
            z-index: 998;
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .menu-overlay.active {
            width: 200px; /* 縮小選單寬度 */
            height: auto;
            max-height: calc(100vh - 50px); /* 最大高度為視窗高度減去導航欄高度 */
        }

        .menu-items {
            padding: 20px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .menu-items a {
            display: block;
            color: white;
            text-decoration: none;
            padding: 10px 0;
            font-size: 16px;
        }

        .menu-overlay.active .menu-items {
            opacity: 1;
        }

        /* 主要內容區域的樣式 */
        .main-content {
            padding: 20px;
            margin-top: 20px; /* 調整與導航欄的間距 */
        }

        @media screen and (max-width: 500px) {
            .fullscreen-button {
                background: rgba(128, 128, 128, 0.5) !important;
                cursor: not-allowed !important;
            }
            
            .fullscreen-button:hover {
                background: rgba(128, 128, 128, 0.5) !important;
            }
            
            .fullscreen-button svg {
                fill: #999;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <div class="hamburger" onclick="toggleMenu()">
            <span></span>
            <span></span>
            <span></span>
        </div>

        <div class="menu-overlay">
            <div class="menu-items">
                <a href="./">首頁</a>
                <a href="calculate.html">幫倒忙計算機</a>
                <a href="51121bobibo.html">51121bobibo</a>
                <a href="greentoeye.html">GGTE</a>
            </div>
        </div>

        <h1>NENP
NO ERROR NO PAIN</h1>
    </header>

    <script>
        function toggleMenu() {
            const menuOverlay = document.querySelector('.menu-overlay');
            menuOverlay.classList.toggle('active');
        }
    </script>

    <h2>51121BoBiBo</h2>
    <div class="container">
        <div id="canvas-container">
            <button class="fullscreen-button" onclick="toggleFullscreen()" title="全螢幕">
                <svg viewBox="0 0 24 24">
                    <path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/>
                </svg>
            </button>
        </div>

        <div class="controls">
            <div class="shape-controls">
                <button onclick="setShape('sphere')" id="sphereBtn" class="active">圓形</button>
                <button onclick="setShape('ellipsoid')" id="ellipsoidBtn">橢圓形</button>
            </div>
            <button onclick="toggleRotation()">開始/暫停旋轉</button>
            
            <div class="speed-controls">
            <label for="speedControl">旋轉速度:</label>
                <input type="range" id="speedControl" min="1" max="30" value="2" step="2" oninput="updateSpeed()">
                <button onclick="toggleSpeed()" class="speed-button" id="speedToggleBtn">我要更快快快</button>
            </div>

            <div class="music-controls">
                <label>選擇音樂:</label>
                <div class="music-buttons" id="musicButtons">
                    <button onclick="changeMusic('music1')" class="music-button active" id="music1Btn">音樂1</button>
                    <button onclick="changeMusic('music2')" class="music-button" id="music2Btn">音樂2</button>
                </div>
            </div>
            
            <button onclick="showDownloadDialog()" class="download-button">
                <svg viewBox="0 0 24 24">
                    <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                </svg>
                下載短影片
            </button>
            
            <div class="image-upload">
                <label>上傳左半部圖片: <input type="file" id="uploadLeft" accept="image/*"></label>
                <label>上傳右半部圖片: <input type="file" id="uploadRight" accept="image/*"></label>
            </div>
        </div>
    </div>

    <div class="dialog-overlay" id="downloadDialog">
        <div class="dialog-box">
            <h3>確認是否下載影片??!</h3>
            <div class="dialog-buttons">
                <button onclick="startRecording()">下載</button>
                <button onclick="hideDialog('downloadDialog')">忍痛放棄</button>
            </div>
        </div>
    </div>

    <div class="dialog-overlay" id="thankDialog">
        <div class="dialog-box">
            <h3>感謝下載</h3>
            <div class="dialog-buttons">
                <button onclick="hideDialog('thankDialog')">確定</button>
            </div>
        </div>
    </div>

    <div class="dialog-overlay" id="downloadingDialog">
        <div class="dialog-box">
            <h3>下載中請稍後...</h3>
            <h3>請勿關閉此頁面(否則你會後悔)</h3>
            <div class="loading-spinner"></div>
        </div>
    </div>

    <div class="dialog-overlay" id="previewDialog">
        <div class="dialog-box">
            <h3>預覽影片</h3>
            <video id="previewVideo" class="preview-video" controls></video>
            <div class="dialog-buttons">
                <button onclick="downloadVideo()">確認下載</button>
                <button onclick="hideDialog('previewDialog')">取消</button>
            </div>
        </div>
    </div>

    <div class="dialog-overlay" id="errorDialog">
        <div class="dialog-box">
            <h3>失敗，你是天選之電腦(mac不行</h3>
            <div class="dialog-buttons">
                <button onclick="hideDialog('errorDialog')">確定</button>
            </div>
        </div>
    </div>

    <script>
        let scene, camera, renderer;
        let isRotating = false;
        let rotationSpeed = 0.02;
        let textureLeft, textureRight;
        let materialLeft, materialRight;
        let leftHalf, rightHalf;
        let currentShape = 'sphere';
        let savedMaterials = {
            sphere: { left: null, right: null },
            ellipsoid: { left: null, right: null }
        };
        
        // 音樂
        const musicList = {
            music1: 'Green Screen Spinning Cat Meme _ OIIAIOIIIAI Meme.mp3',
            music2: 'bo bi bo bi bo bo bi bo cat.mp3'
        };
        
        let currentMusic = 'music1';
        let bgMusic = new Audio(musicList[currentMusic]);
        bgMusic.loop = true;
        bgMusic.volume = 0.5; 
        
        let isHighSpeed = false;  
        
        let capturer = null;
        let isRecording = false;
        let recordingFrames = 0;
        const RECORD_FPS = 30;
        const RECORD_DURATION = 10; // 10秒
        const MAX_RECORD_DURATION = 15; // 最大录制时间15秒
        let mediaRecorder = null;
        let audioContext = null;
        let audioDestination = null;
        let recordedChunks = [];
        let currentVideoBlob = null;
        let recordingStartTime = 0;
        
        init();
        animate();

        function init() {
            
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0xffffff);  // 白色背景

            
            camera = new THREE.PerspectiveCamera(75, 1, 0.1, 1000);
            camera.position.z = 3;

            
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(400, 400);
            const container = document.getElementById('canvas-container');
            container.appendChild(renderer.domElement);

            // 房東的水印
            const watermark = document.createElement('div');
            watermark.className = 'watermark';
            watermark.textContent = 'Made by NENP';
            container.appendChild(watermark);

            // 全屏點擊
            container.addEventListener('click', function(e) {
                if ((document.fullscreenElement || document.webkitFullscreenElement || document.mozFullScreenElement || document.msFullscreenElement) && 
                    !e.target.classList.contains('fullscreen-button')) {
                    exitFullscreen();
                }
            });

            createShape('sphere');
            loadSavedTextures();
            
            
            window.addEventListener('resize', handleResize);
            
            
            handleResize();
            
            
            updateDownloadButtonState();
            
        
            window.addEventListener('resize', updateDownloadButtonState);
        }

        function createShape(shapeType) {
            
            if (materialLeft && materialLeft.map) {
                savedMaterials[currentShape].left = materialLeft.map;
            }
            if (materialRight && materialRight.map) {
                savedMaterials[currentShape].right = materialRight.map;
            }

            
            if (leftHalf) scene.remove(leftHalf);
            if (rightHalf) scene.remove(rightHalf);

            
            let scaleX = shapeType === 'ellipsoid' ? 1.5 : 1;
            let scaleY = 1;
            let scaleZ = shapeType === 'ellipsoid' ? 0.8 : 1;

            
            const geometryLeft = new THREE.SphereGeometry(1, 32, 32, 0, Math.PI);
            materialLeft = new THREE.MeshBasicMaterial({
                side: THREE.DoubleSide,
                color: 0xcccccc
            });
            
            
            if (savedMaterials[shapeType].left) {
                materialLeft.map = savedMaterials[shapeType].left;
                materialLeft.needsUpdate = true;
            }
            
            leftHalf = new THREE.Mesh(geometryLeft, materialLeft);
            leftHalf.scale.set(scaleX, scaleY, scaleZ);
            scene.add(leftHalf);

            // 右半
            const geometryRight = new THREE.SphereGeometry(1, 32, 32, Math.PI, Math.PI);
            materialRight = new THREE.MeshBasicMaterial({
                side: THREE.DoubleSide,
                color: 0xcccccc
            });
            
            
            if (savedMaterials[shapeType].right) {
                materialRight.map = savedMaterials[shapeType].right;
                materialRight.needsUpdate = true;
            }
            
            rightHalf = new THREE.Mesh(geometryRight, materialRight);
            rightHalf.scale.set(scaleX, scaleY, scaleZ);
            scene.add(rightHalf);

            // 更新按鈕狀態
            document.getElementById('sphereBtn').classList.toggle('active', shapeType === 'sphere');
            document.getElementById('ellipsoidBtn').classList.toggle('active', shapeType === 'ellipsoid');
        }

        function setShape(shapeType) {
            currentShape = shapeType;
            createShape(shapeType);
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if (isRotating) {
                scene.rotation.y += rotationSpeed;
            }
            
            renderer.render(scene, camera);
            
            if (isRecording) {
                recordingFrames++;
                capturer.capture(renderer.domElement);
                
                if (recordingFrames >= RECORD_FPS * RECORD_DURATION) {
                    stopRecording();
                }
            }
        }

        function toggleRotation() {
            isRotating = !isRotating;
            
            if (isRotating) {
                bgMusic.play().catch(function(error) {
                    console.log("音樂播放失敗：", error);
                });
            } else {
                bgMusic.pause();
                bgMusic.currentTime = 0;
            }
        }

        function toggleSpeed() {
            isHighSpeed = !isHighSpeed;
            const speedControl = document.getElementById("speedControl");
            const speedToggleBtn = document.getElementById("speedToggleBtn");
            
            if (isHighSpeed) {
                speedControl.value = 50;
                speedToggleBtn.textContent = "我要慢慢慢";
                speedToggleBtn.style.background = "#ff4444";
            } else {
                speedControl.value = 2;
                speedToggleBtn.textContent = "我要更快快快";
                speedToggleBtn.style.background = "#2196F3";
            }
            updateSpeed();
        }

        function updateSpeed() {
            rotationSpeed = document.getElementById("speedControl").value * 0.01;
        }

        function loadSavedTextures() {
            const savedLeft = localStorage.getItem("leftImage") || "Catoh.JPG";
            const savedRight = localStorage.getItem("rightImage") || "Wee.WEBP";
            //const savedLeft = localStorage.getItem("leftImage");
            //const savedRight = localStorage.getItem("rightImage");
            const savedShape = localStorage.getItem("currentShape") || 'sphere';

            if (savedLeft) {
                applyTexture(savedLeft, materialLeft);
                
                const texture = new THREE.TextureLoader().load(savedLeft);
                savedMaterials.sphere.left = texture;
                savedMaterials.ellipsoid.left = texture;
            }
            if (savedRight) {
                applyTexture(savedRight, materialRight);
                
                const texture = new THREE.TextureLoader().load(savedRight);
                savedMaterials.sphere.right = texture;
                savedMaterials.ellipsoid.right = texture;
            }
            
            
            if (savedShape !== currentShape) {
                setShape(savedShape);
            }
        }

        function applyTexture(imageData, material) {
            const texture = new THREE.TextureLoader().load(imageData);
            material.map = texture;
            material.needsUpdate = true;
            
            
            if (material === materialLeft) {
                savedMaterials.sphere.left = texture;
                savedMaterials.ellipsoid.left = texture;
            } else if (material === materialRight) {
                savedMaterials.sphere.right = texture;
                savedMaterials.ellipsoid.right = texture;
            }
        }

        function handleImageUpload(event, material, storageKey) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imageData = e.target.result;
                    applyTexture(imageData, material);
                    localStorage.setItem(storageKey, imageData);
                    // 保存當前形狀
                    localStorage.setItem("currentShape", currentShape);
                };
                reader.readAsDataURL(file);
            }
        }

        document.getElementById("uploadLeft").addEventListener("change", function(event) {
            handleImageUpload(event, materialLeft, "leftImage");
        });

        document.getElementById("uploadRight").addEventListener("change", function(event) {
            handleImageUpload(event, materialRight, "rightImage");
        });

        function changeMusic(musicId) {
            // 保存當前播放狀態
            const wasPlaying = !bgMusic.paused;
            
            // 停止當前音樂
            bgMusic.pause();
            bgMusic.currentTime = 0;
            
            // 更新當前音樂
            currentMusic = musicId;
            bgMusic = new Audio(musicList[musicId]);
            bgMusic.loop = true;
            bgMusic.volume = 0.5;
            
            // 如果之前在播放，則繼續播放新音樂
            if (wasPlaying) {
                bgMusic.play().catch(function(error) {
                    console.log("音樂播放失敗：", error);
                });
            }
            
            // 更新按鈕狀態
            document.querySelectorAll('.music-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.getElementById(musicId + 'Btn').classList.add('active');
            
            // 保存音樂選擇
            localStorage.setItem('selectedMusic', musicId);
        }

        // 載入保存的音樂選擇
        window.addEventListener('load', function() {
            const savedMusic = localStorage.getItem('selectedMusic');
            if (savedMusic && musicList[savedMusic]) {
                changeMusic(savedMusic);
            }
        });

        function exitFullscreen() {
            if (document.exitFullscreen) {
                document.exitFullscreen();
            } else if (document.webkitExitFullscreen) {
                document.webkitExitFullscreen();
            } else if (document.mozCancelFullScreen) {
                document.mozCancelFullScreen();
            } else if (document.msExitFullscreen) {
                document.msExitFullscreen();
            }
            const container = document.getElementById('canvas-container');
            container.classList.remove('fullscreen');
            handleResize();
        }

        function toggleFullscreen() {
            // 檢查螢幕寬度
            if (window.innerWidth <= 500) {
                alert('不支援手機板全螢幕(我就爛');
                return;
            }
            
            const container = document.getElementById('canvas-container');
            
            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                // 進入全螢幕
                if (container.requestFullscreen) {
                    container.requestFullscreen();
                } else if (container.webkitRequestFullscreen) {
                    container.webkitRequestFullscreen();
                } else if (container.mozRequestFullScreen) {
                    container.mozRequestFullScreen();
                } else if (container.msRequestFullscreen) {
                    container.msRequestFullscreen();
                }
                container.classList.add('fullscreen');
                
                // 調整渲染器大小為全螢幕
                const width = window.innerWidth;
                const height = window.innerHeight;
                renderer.setSize(width, height);
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
            } else {
                exitFullscreen();
            }
        }
        
        // 監聽全螢幕變化
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);

        function handleFullscreenChange() {
            const container = document.getElementById('canvas-container');
            if (!document.fullscreenElement && !document.webkitFullscreenElement && 
                !document.mozFullScreenElement && !document.msFullscreenElement) {
                container.classList.remove('fullscreen');
                handleResize();
            }
        }
        
        // 監聽視窗大小變化
        window.addEventListener('resize', function() {
            if (document.fullscreenElement) {
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

        function showDownloadDialog() {
            document.getElementById('downloadDialog').style.display = 'flex';
        }
        
        function hideDialog(dialogId) {
            document.getElementById(dialogId).style.display = 'none';
        }
        
        function startRecording() {
            audioContext.resume().then(() => console.log("AudioContext resumed"));

            hideDialog('downloadDialog');
            document.getElementById('downloadingDialog').style.display = 'flex';
            document.getElementById('downloadingDialog').querySelector('h3').textContent = '錄製中請稍後...';

            
            const tempCanvas = document.createElement('canvas');
            const tempCtx = tempCanvas.getContext('2d');
            tempCanvas.width = renderer.domElement.width;
            tempCanvas.height = renderer.domElement.height;
            
            
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            audioDestination = audioContext.createMediaStreamDestination();

            
            const audioElement = new Audio(musicList[currentMusic]);
            audioElement.loop = true;
            audioElement.volume = 0.5;
            
        
            const audioSource = audioContext.createMediaElementSource(audioElement);
            audioSource.connect(audioDestination);
            
       
            const originalAnimate = animate;
            animate = function() {
                requestAnimationFrame(animate);
                
                if (isRotating) {
                    scene.rotation.y += rotationSpeed;
                }
                
                renderer.render(scene, camera);
                
         
                tempCtx.drawImage(renderer.domElement, 0, 0);
                
                // 繪製水印
                tempCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                tempCtx.fillRect(tempCanvas.width - 100, tempCanvas.height - 40, 90, 30);
                tempCtx.fillStyle = 'white';
                tempCtx.font = 'bold 12px Arial';
                tempCtx.textAlign = 'center';
                tempCtx.textBaseline = 'middle';
                tempCtx.fillText('Made by NENP', tempCanvas.width - 55, tempCanvas.height - 25);
            };
            
            
            const canvasStream = tempCanvas.captureStream(RECORD_FPS);
            
            // 合併音和視
            const tracks = [...canvasStream.getVideoTracks(), ...audioDestination.stream.getAudioTracks()];
            const combinedStream = new MediaStream(tracks);
            
            // 創建 MediaRecorder
            let options = {
                mimeType: 'video/webm;codecs=vp8,opus',
                videoBitsPerSecond: 5000000,
                audioBitsPerSecond: 128000
            };
            
            mediaRecorder = new MediaRecorder(combinedStream, options);
            
            recordedChunks = [];
            mediaRecorder.ondataavailable = (event) => {
                if (event.data.size > 0) {
                    recordedChunks.push(event.data);
                }
                
                // 检查录制时间
                const currentTime = Date.now();
                const recordingDuration = (currentTime - recordingStartTime) / 1000;
                
                if (recordingDuration > MAX_RECORD_DURATION) {
                    if (mediaRecorder && mediaRecorder.state === 'recording') {
                        mediaRecorder.stop();
                        audioElement.pause();
                        audioElement.currentTime = 0;
                        isRotating = false;
                        
                        // 显示错误对话框
                        hideDialog('downloadingDialog');
                        document.getElementById('errorDialog').style.display = 'flex';
                        recordedChunks = []; // 清空已录制的数据
                    }
                }
            };
            
            mediaRecorder.onstop = async () => {
                // 恢復原始的 animate 函數
                animate = originalAnimate;

                const recordedBlob = new Blob(recordedChunks, { type: 'video/webm' });
                currentVideoBlob = recordedBlob;
                
                // 關閉音頻上下文
                audioContext.close();
                
                // 隱藏下載中對話框
                hideDialog('downloadingDialog');
                
                // 顯示預覽
                const previewVideo = document.getElementById('previewVideo');
                previewVideo.src = URL.createObjectURL(currentVideoBlob);
                document.getElementById('previewDialog').style.display = 'flex';
                bgMusic.pause();
            };
            
            // 开始录制时记录开始时间
            recordingStartTime = Date.now();
            mediaRecorder.start(1000);
            
            // 確保音頻播放
            audioElement.currentTime = 0;
            audioElement.play().catch(function(error) {
                console.log("音樂播放失敗：", error);
            });
            
            // 確保動畫在錄製時運行
            if (!isRotating) {
                isRotating = true;
                scene.rotation.y = 0;
            }
        }

        function downloadVideo() {
            if (!currentVideoBlob) return;
            
            const url = URL.createObjectURL(currentVideoBlob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'NENP_51121popipo.mp4';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            hideDialog('previewDialog');
            document.getElementById('thankDialog').style.display = 'flex';
            bgMusic.pause();
        }

        function handleResize() {
            const container = document.getElementById('canvas-container');
            const isMobileView = window.innerWidth <= 726;
            
            if (isMobileView) {
                
                const newWidth = Math.min(container.clientWidth, 400);
                const newHeight = newWidth; // 保持正方形
                
                
                renderer.setSize(newWidth, newHeight);
                
                
                camera.aspect = 1;
                camera.updateProjectionMatrix();
            } else {
                
                renderer.setSize(400, 400);
                camera.aspect = 1;
                camera.updateProjectionMatrix();
            }
        }

        
        function updateDownloadButtonState() {
            const downloadButton = document.querySelector('.download-button');
            const previewDownloadButton = document.querySelector('#previewDialog button');
            
            downloadButton.style.backgroundColor = '#4CAF50';
            downloadButton.style.cursor = 'pointer';
            downloadButton.style.opacity = '1';
            if (previewDownloadButton) {
                previewDownloadButton.style.backgroundColor = '#4CAF50';
                previewDownloadButton.style.cursor = 'pointer';
                previewDownloadButton.style.opacity = '1';
            }
        }
    </script>
</body>
</html>